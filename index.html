<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FittingBox VTO Demo</title>
    <style>
      #vtoContainer {
        width: 640px;
        height: 480px;
        border: 1px solid #ccc;
        margin-bottom: 10px;
      }
      #controls {
        margin-top: 15px;
      }
      button {
        margin-right: 8px;
        padding: 8px 12px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        background: #007bff;
        color: white;
      }
      button:hover {
        background: #0056b3;
      }
      #snapshotResult {
        margin-top: 20px;
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      .loading {
        color: #666;
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <h2>👓 FittingBox Virtual Try-On Demo</h2>

    <!-- Container where VTO will be mounted -->
    <div id="vtoContainer">
      <p class="loading">Loading VTO, please wait...</p>
    </div>

    <!-- Controls -->
    <div id="controls">
      <button id="startLive" disabled>Start Live</button>
      <button id="stopLive" disabled>Stop</button>
      <button id="snapshot" disabled>Take Snapshot</button>
      <button id="frame1" disabled>Frame 1</button>
      <button id="frame2" disabled>Frame 2</button>
      <button id="frame3" disabled>Frame 3</button>
    </div>

    <!-- Snapshot preview -->
    <div id="snapshotResult"></div>

    <!-- Load the FittingBox VTO script -->
    <script src="https://vto-advanced-sdk.fittingbox.com/vto-advanced.js"></script>

    <script>
      let vto;
      let isVtoReady = false;

      function initVTO() {
        // Check if VTOAdvanced is available
        if (typeof VTOAdvanced === 'undefined') {
          console.error('VTOAdvanced is not defined. Script may not have loaded properly.');
          return;
        }

        const container = document.getElementById("vtoContainer");

        try {
          // Initialize the VTO instance
          vto = new VTOAdvanced({
            apiKey: "TBVAcXitApiZPVH791yxdHbAc8AKzBwtCnjtv6Xn",
            frame: "8053672909258",
            width: container.clientWidth,
            height: container.clientHeight,
            lang: "en",
            uiConfiguration: {
              livePhotoButton: true,
              cameraPermissionScreen: true,
              photoWelcomeScreen: false,
              vtoLoadingScreen: true,
            },
          });

          // Callbacks
          vto.onIssue = (data) => {
            console.warn("⚠️ Issue:", data);
          };

          vto.onSnapshot = (result) => {
            console.log("📸 Snapshot result:", result);
            const img = document.createElement("img");
            img.src = result.dataUrl;
            img.width = 300;
            document.getElementById("snapshotResult").innerHTML = "";
            document.getElementById("snapshotResult").appendChild(img);
          };

          vto.onPhotoRender = (res) => {
            console.log("🎨 Photo render:", res);
          };

          vto.onLiveStatus = (status) => {
            console.log("📡 Live status:", status);
          };

          vto.onMode = (mode) => {
            console.log("🔄 Mode changed to:", mode);
          };
          
          vto.onOpenStream = (value) => {
            if (value.success) {
              console.log("✅ VTO initialized successfully");
              enableButtons();
              isVtoReady = true;
              // Remove loading message
              const loadingMsg = document.querySelector('#vtoContainer .loading');
              if (loadingMsg) loadingMsg.remove();
            }
          };
          
        } catch (error) {
          console.error("❌ Error initializing VTO:", error);
        }
      }

      function enableButtons() {
        document.getElementById("startLive").disabled = false;
        document.getElementById("stopLive").disabled = false;
        document.getElementById("snapshot").disabled = false;
        document.getElementById("frame1").disabled = false;
        document.getElementById("frame2").disabled = false;
        document.getElementById("frame3").disabled = false;
      }

      // Wait for the VTO script to load before initializing
      function checkVTOLoaded() {
        if (typeof VTOAdvanced !== 'undefined') {
          initVTO();
        } else {
          // Check again after a short delay
          setTimeout(checkVTOLoaded, 100);
        }
      }

      // Start checking if VTO script is loaded
      window.addEventListener('load', function() {
        checkVTOLoaded();
      });

      // Controls with safety checks
      document.getElementById("startLive").onclick = () => {
        if (isVtoReady) vto.startVto("live");
      };
      
      document.getElementById("stopLive").onclick = () => {
        if (isVtoReady) vto.stopVto();
      };
      
      document.getElementById("snapshot").onclick = () => {
        if (isVtoReady) vto.getSnapshot();
      };

      // Frame switch buttons
      document.getElementById("frame1").onclick = () => {
        if (isVtoReady) vto.setFrame("8053672909258");
      };
      
      document.getElementById("frame2").onclick = () => {
        if (isVtoReady) vto.setFrame("0888392486523");
      };
      
      document.getElementById("frame3").onclick = () => {
        if (isVtoReady) vto.setFrame("8056597233958");
      };
    </script>
  </body>
</html>